{"version":3,"file":"sifrr.serviceworker.module.js","sources":["../src/sifrr.serviceworker.js"],"sourcesContent":["class SW {\n  constructor(options) {\n    this.options = Object.assign({\n      version: 1,\n      fallbackCacheName: 'fallbacks',\n      defaultCacheName: 'default',\n      policies: {},\n      fallbacks: {},\n      precacheUrls: []\n    }, options);\n    this.options.policies.default = Object.assign(this.options.policies.default || {}, {\n      policy: 'NETWORK_FIRST',\n      cacheName: this.options.defaultCacheName\n    });\n  }\n\n  setup() {\n    self.addEventListener('install', this.installEventListener.bind(this));\n    self.addEventListener('activate', this.activateEventListener.bind(this));\n    self.addEventListener('fetch', this.fetchEventListener.bind(this));\n  }\n\n  setupPushNotification(defaultTitle = '', defaultOptions = { body: '' }) {\n    this.defaultPushTitle = defaultTitle;\n    this.defaultPushOptions = defaultOptions;\n    self.addEventListener('push', this.pushEventListener.bind(this));\n    self.addEventListener('notificationclick', this.onNotificationClick.bind(this));\n  }\n\n  installEventListener(event) {\n    event.waitUntil(this.precache());\n    this.onInstall(event);\n  }\n\n  /* istanbul ignore next */\n  onInstall() {}\n\n  activateEventListener() {\n    const version = '-v' + this.options.version;\n    // remove old version caches\n    caches.keys().then(cacheNames => {\n      // [FIX] -v1 won't delete -v10\n      return cacheNames.filter(cacheName => cacheName.indexOf(version) < 0);\n    }).then(cachesToDelete => {\n      return Promise.all(cachesToDelete.map(cacheToDelete => {\n        return caches.delete(cacheToDelete);\n      }));\n    }).then(() => self.clients.claim());\n  }\n\n  fetchEventListener(event) {\n    const request = event.request;\n    const otherReq = request.clone();\n    const oreq = request.clone();\n    if (request.method === 'GET') {\n      event.respondWith(this.respondWithPolicy(request).then(response => {\n        if (!response.ok && response.status > 0 && this.findRegex(oreq.url, this.options.fallbacks)) {\n          throw Error('response status ' + response.status);\n        }\n        return response;\n      }).catch((e) => this.respondWithFallback(otherReq, e)));\n    }\n  }\n\n  pushEventListener(event) {\n    let data = {};\n    if (event.data) {\n      if (typeof event.data.json === 'function') data = event.data.json();\n      else data = event.data || {};\n    }\n\n    const title = data.title || this.defaultPushTitle;\n    const options = Object.assign(this.defaultPushOptions, data);\n\n    return self.registration.showNotification(title, options);\n  }\n\n  /* istanbul ignore next */\n  onNotificationClick() {}\n\n  precache(urls = this.options.precacheUrls, fbs = this.options.fallbacks) {\n    const me = this;\n    let promises = [];\n    urls.forEach(u => {\n      let req = me.createRequest(u);\n      return promises.push(me.responseFromNetwork(req, me.findRegex(u, me.options.policies).cacheName));\n    });\n    for (let value of Object.values(fbs)) {\n      let req = this.createRequest(value);\n      promises.push(this.responseFromNetwork(req, this.options.fallbackCacheName));\n    }\n    return Promise.all(promises);\n  }\n\n  respondWithFallback(request, error) {\n    const fallback = this.createRequest(this.findRegex(request.url, this.options.fallbacks));\n    if (fallback !== undefined) {\n      return this.responseFromCache(fallback, this.options.fallbackCacheName);\n    } else {\n      /* istanbul ignore next */\n      throw error;\n    }\n  }\n\n  respondWithPolicy(request) {\n    const req1 = request.clone();\n    const req2 = request.clone();\n    const config = this.findRegex(request.url, this.options.policies);\n    const policy = config.policy;\n    const cacheName = config.cacheName || this.options.defaultCacheName;\n\n    let resp;\n    switch (policy) {\n    case 'NETWORK_ONLY':\n      resp = this.responseFromNetwork(req1, cacheName, false);\n      break;\n    case 'CACHE_FIRST':\n    case 'CACHE_ONLY':\n      resp = this.responseFromCache(req1, cacheName).catch(() => this.responseFromNetwork(request, cacheName));\n      break;\n    case 'CACHE_AND_UPDATE':\n      resp = this.responseFromCache(req1, cacheName).catch(() => this.responseFromNetwork(request, cacheName));\n      this.responseFromNetwork(req2, cacheName);\n      break;\n    default:\n      resp = this.responseFromNetwork(req1, cacheName).catch(() => this.responseFromCache(request, cacheName));\n      break;\n    }\n    return resp;\n  }\n\n  responseFromNetwork(request, cache, putInCache = true) {\n    return caches.open(cache + '-v' + this.options.version).then(cache => fetch(request).then(response => {\n      if (putInCache) cache.put(request, response.clone());\n      return response;\n    }));\n  }\n\n  responseFromCache(request, cache) {\n    return caches.open(cache + '-v' + this.options.version).then(cache => cache.match(request)).then(resp => {\n      if (resp) return resp;\n      else throw 'Cache not found for ' + request.url;\n    });\n  }\n\n  createRequest(url, data = { method: 'GET' }) {\n    return new Request(url, data);\n  }\n\n  findRegex(url, policies) {\n    for (let [key, value] of Object.entries(policies)) {\n      const regex = new RegExp(key);\n      if (regex.test(url)) return value;\n    }\n    return policies['default'];\n  }\n}\n\nmodule.exports = SW;\n"],"names":[],"mappings":"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"}