{"version":3,"file":"sifrr.seo.module.js","sources":["../src/pagerequest.js","../src/renderer.js","../src/getcache.js","../src/constants.js","../src/middleware.js","../src/sifrr.seo.js"],"sourcesContent":["const whiteTypes = ['document', 'script', 'xhr', 'fetch'];\n\nfunction isTypeOf(request, types) {\n  const resType = request.resourceType();\n  return types.indexOf(resType) !== -1;\n}\n\nclass PageRequest {\n  constructor(npage, filter = () => true) {\n    this.npage = npage;\n    this.filter = filter;\n    this.pendingRequests = 0;\n    this.pendingPromise = new Promise(res => (this.pendingResolver = res));\n    this.addOnRequestListener();\n    this.addEndRequestListener();\n  }\n\n  addOnRequestListener() {\n    const me = this;\n    this.addListener = this.npage.setRequestInterception(true).then(() => {\n      me.npage.on('request', request => {\n        if (isTypeOf(request, whiteTypes) && this.filter(request.url())) {\n          me.pendingRequests++;\n          request.__allowed = true;\n          request.continue();\n        } else {\n          request.__allowed = false;\n          request.abort();\n        }\n      });\n    });\n  }\n\n  addEndRequestListener() {\n    // resolve pending fetch/xhrs\n    const me = this;\n    this.npage.on('requestfailed', request => {\n      me.onEnd(request);\n    });\n    this.npage.on('requestfinished', request => {\n      me.onEnd(request);\n    });\n  }\n\n  onEnd(request) {\n    if (request.__allowed) {\n      this.pendingRequests--;\n      if (this.pendingRequests === 0) this.pendingResolver();\n    }\n  }\n\n  all() {\n    if (this.pendingRequests === 0) return Promise.resolve(true);\n    return this.pendingPromise;\n  }\n}\n\nmodule.exports = PageRequest;\n","const puppeteer = require('puppeteer');\nconst PageRequest = require('./pagerequest');\n// status\n// 0: closed\n// 1: launching\n// 2: launched\n\nclass Renderer {\n  constructor(puppeteerOptions = {}, options = {}) {\n    this.status = 0;\n    this.puppeteerOptions = Object.assign(\n      {\n        headless: true,\n        args: []\n      },\n      puppeteerOptions\n    );\n    this.puppeteerOptions.args.push('--no-sandbox', '--disable-setuid-sandbox');\n    this.options = options;\n  }\n\n  async browserAsync() {\n    if (!this._browser) {\n      this._browser = puppeteer.launch(this.puppeteerOptions).then(b => {\n        b.on('disconnected', () => {\n          /* istanbul ignore next */\n          this._browser = null;\n        });\n        return b;\n      });\n    }\n    return this._browser;\n  }\n\n  close() {\n    if (this._browser) return this.browserAsync().then(b => b.close());\n    else return Promise.resolve(true);\n  }\n\n  render(url, headers = {}) {\n    const me = this;\n\n    return this.browserAsync()\n      .then(b => b.newPage())\n      .then(async newp => {\n        const fetches = new PageRequest(newp, me.options.filterOutgoingRequests);\n        await fetches.addListener;\n\n        delete headers['user-agent'];\n        await newp.setExtraHTTPHeaders(headers);\n        /* istanbul ignore next */\n        if (me.options.beforeRender) await newp.evaluateOnNewDocument(me.options.beforeRender);\n        const resp = await newp.goto(url, { waitUntil: 'load' });\n        const sRC = me.isHTML(resp);\n        let ret;\n\n        if (sRC) {\n          await fetches.all();\n          /* istanbul ignore next */\n          if (me.options.afterRender) await newp.evaluate(me.options.afterRender);\n          ret = await newp.content();\n        } else ret = false;\n\n        await newp.close();\n        return ret;\n      });\n  }\n\n  isHTML(puppeteerResp) {\n    return (\n      puppeteerResp.headers()['content-type'] &&\n      puppeteerResp.headers()['content-type'].indexOf('html') >= 0\n    );\n  }\n}\n\nmodule.exports = Renderer;\n","const Cache = require('cache-manager');\n\nmodule.exports = ops => {\n  ops = Object.assign(\n    {\n      cacheStore: 'memory',\n      maxCacheSize: 100, // in MB\n      ttl: 0 // in Seconds\n    },\n    ops\n  );\n\n  return Cache.caching({\n    store: ops.cacheStore,\n    ttl: ops.ttl,\n    length: (val, key) => {\n      return Buffer.from(key + key + val).length + 2;\n    },\n    max: ops.maxCacheSize * 1000000\n  });\n};\n","module.exports = {\n  noop: () => {},\n  headerName: 'X-SSR-Powered-By',\n  headerValue: '@sifrr/seo'\n};\n","const { headerName, headerValue } = require('./constants');\n\n// this = sifrr seo instance\nmodule.exports = getUrl => {\n  return function(req, res, next) {\n    // Don't render other requests than GET\n    if (req.method !== 'GET') return next();\n\n    const url = getUrl(req);\n    const headers = req.headers;\n\n    if (this.getShouldRenderCache(url, headers) === null) {\n      res._end = res.end;\n      res.end = (resp, encoding) => {\n        if (res.hasHeader('content-type')) {\n          const contentType = res.getHeader('content-type');\n          if (contentType.indexOf('html') >= 0) {\n            this.setShouldRenderCache(url, headers, true);\n          } else {\n            this.setShouldRenderCache(url, headers, false);\n          }\n        }\n        res._end(resp, encoding);\n      };\n    }\n\n    return this.render(url, headers)\n      .then(html => {\n        if (html) {\n          res.set(headerName, headerValue);\n          res.send(html);\n        } else {\n          next();\n        }\n      })\n      .catch(e => {\n        if (e.message === 'No Render') {\n          next();\n        } else next(e);\n      });\n  };\n};\n","const Renderer = require('./renderer');\nconst isHeadless = new RegExp('(headless|Headless)');\nconst getCache = require('./getcache');\n\nclass SifrrSeo {\n  constructor(\n    userAgents = [\n      'Googlebot', // Google\n      'Bingbot', // Bing\n      'Slurp', // Slurp\n      'DuckDuckBot', // DuckDuckGo\n      'Baiduspider', //Baidu\n      'YandexBot', // Yandex\n      'Sogou', // Sogou\n      'Exabot' // Exalead\n    ],\n    options = {}\n  ) {\n    this._uas = userAgents.map(ua => new RegExp(ua));\n    this.shouldRenderCache = {};\n    this.options = Object.assign(\n      {\n        cacheKey: url => url\n      },\n      options\n    );\n  }\n\n  get renderer() {\n    this._renderer = this._renderer || new SifrrSeo.Renderer(this._poptions, this.options);\n    return this._renderer;\n  }\n\n  get cache() {\n    this._cache = this._cache || getCache(this.options);\n    return this._cache;\n  }\n\n  getExpressMiddleware(getUrl = expressReq => `http://127.0.0.1:80${expressReq.originalUrl}`) {\n    return require('./middleware')(getUrl).bind(this);\n  }\n\n  addUserAgent(userAgent) {\n    this._uas.push(new RegExp(userAgent));\n  }\n\n  setPuppeteerOption(name, value) {\n    this._poptions = this._poptions || {};\n    this._poptions[name] = value;\n  }\n\n  close() {\n    return this.renderer.close();\n  }\n\n  shouldRender(url, headers) {\n    return this._isUserAgent(headers);\n  }\n\n  setShouldRenderCache(url, headers, val) {\n    const key = this.options.cacheKey(url, headers);\n    this.shouldRenderCache[key] = val;\n  }\n\n  getShouldRenderCache(url, headers) {\n    const key = this.options.cacheKey(url, headers);\n    if (this.shouldRenderCache[key] === undefined) return null;\n    return this.shouldRenderCache[key];\n  }\n\n  clearCache() {\n    this.cache.reset();\n  }\n\n  async render(url, headers) {\n    if (this.getShouldRenderCache(url, headers) === false) {\n      throw Error(`No Render`);\n    } else if (this.shouldRender(url, headers) && !this._isHeadless(headers)) {\n      const key = this.options.cacheKey(url, headers);\n      return new Promise((res, rej) => {\n        this.cache.get(key, (err, val) => {\n          /* istanbul ignore if */\n          if (err) {\n            rej(err);\n          } else if (!val) {\n            this.renderer\n              .render(url, headers)\n              .then(resp => {\n                this.cache.set(key, resp);\n                res(resp);\n              })\n              .catch(\n                /* istanbul ignore next */ err => {\n                  rej(err);\n                }\n              );\n          } else {\n            res(val);\n          }\n        });\n      });\n    } else {\n      throw Error(`No Render`);\n    }\n  }\n\n  _isHeadless(headers = {}) {\n    return !!isHeadless.test(headers['user-agent']);\n  }\n\n  _isUserAgent(headers = {}) {\n    const ua = headers['user-agent'];\n    let ret = false;\n    this._uas.forEach(b => {\n      if (b.test(ua)) ret = true;\n    });\n    return ret;\n  }\n}\n\nSifrrSeo.Renderer = Renderer;\n\nmodule.exports = SifrrSeo;\n"],"names":["whiteTypes","isTypeOf","request","types","resType","resourceType","indexOf","PageRequest","constructor","npage","filter","pendingRequests","pendingPromise","Promise","res","pendingResolver","addOnRequestListener","addEndRequestListener","me","addListener","setRequestInterception","then","on","url","__allowed","continue","abort","onEnd","all","resolve","Renderer","puppeteerOptions","options","status","Object","assign","headless","args","push","browserAsync","_browser","puppeteer","launch","b","close","render","headers","newPage","newp","fetches","filterOutgoingRequests","setExtraHTTPHeaders","beforeRender","evaluateOnNewDocument","resp","goto","waitUntil","sRC","isHTML","ret","afterRender","evaluate","content","puppeteerResp","ops","cacheStore","maxCacheSize","ttl","Cache","caching","store","length","val","key","Buffer","from","max","noop","headerName","headerValue","require$$0","getUrl","req","next","method","getShouldRenderCache","_end","end","encoding","hasHeader","contentType","getHeader","setShouldRenderCache","html","set","send","catch","e","message","isHeadless","RegExp","SifrrSeo","userAgents","_uas","map","ua","shouldRenderCache","cacheKey","renderer","_renderer","_poptions","cache","_cache","getCache","getExpressMiddleware","expressReq","originalUrl","bind","addUserAgent","userAgent","setPuppeteerOption","name","value","shouldRender","_isUserAgent","undefined","clearCache","reset","Error","_isHeadless","rej","get","err","test","forEach"],"mappings":"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"}