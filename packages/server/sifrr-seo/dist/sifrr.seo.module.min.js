/*! Sifrr.Seo v0.0.5 - sifrr project | MIT licensed | https://github.com/sifrr/sifrr */
import e from"puppeteer";import t from"cache-manager";function n(e,t,n,s,r,o,i){try{var h=e[o](i),d=h.value}catch(e){return void n(e)}h.done?t(d):Promise.resolve(d).then(s,r)}function s(e){return function(){var t=this,s=arguments;return new Promise(function(r,o){var i=e.apply(t,s);function h(e){n(i,r,o,h,d,"next",e)}function d(e){n(i,r,o,h,d,"throw",e)}h(void 0)})}}const r=["document","script","xhr","fetch"];var o=class{constructor(e,t=(()=>!0)){this.npage=e,this.filter=t,this.pendingRequests=0,this.pendingPromise=new Promise(e=>this.pendingResolver=e),this.addOnRequestListener(),this.addEndRequestListener()}addOnRequestListener(){const e=this;this.addListener=this.npage.setRequestInterception(!0).then(()=>{e.npage.on("request",t=>{(function(e,t){const n=e.resourceType();return-1!==t.indexOf(n)})(t,r)&&this.filter(t.url())?(e.pendingRequests++,t.__allowed=!0,t.continue()):(t.__allowed=!1,t.abort())})})}addEndRequestListener(){const e=this;this.npage.on("requestfailed",t=>{e.onEnd(t)}),this.npage.on("requestfinished",t=>{e.onEnd(t)})}onEnd(e){e.__allowed&&(this.pendingRequests--,0===this.pendingRequests&&this.pendingResolver())}all(){return 0===this.pendingRequests?Promise.resolve(!0):this.pendingPromise}};var i=class{constructor(e={},t={}){this.status=0,this.puppeteerOptions=Object.assign({headless:!0,args:[]},e),this.puppeteerOptions.args.push("--no-sandbox","--disable-setuid-sandbox"),this.options=t}browserAsync(){var t=this;return s(function*(){return t._browser||(t._browser=e.launch(t.puppeteerOptions).then(e=>(e.on("disconnected",()=>{t._browser=null}),e))),t._browser})()}close(){return this._browser?this.browserAsync().then(e=>e.close()):Promise.resolve(!0)}render(e,t={}){const n=this;return this.browserAsync().then(e=>e.newPage()).then((
/* */
r=s(function*(s){const r=new o(s,n.options.filterOutgoingRequests);yield r.addListener,delete t["user-agent"],yield s.setExtraHTTPHeaders(t),n.options.beforeRender&&(yield s.evaluateOnNewDocument(n.options.beforeRender));const i=yield s.goto(e,{waitUntil:"load"});let h;return n.isHTML(i)?(yield r.all(),n.options.afterRender&&(yield s.evaluate(n.options.afterRender)),h=yield s.content()):h=!1,yield s.close(),h}),function(e){return r.apply(this,arguments)}));var r}isHTML(e){return e.headers()["content-type"]&&e.headers()["content-type"].indexOf("html")>=0}},h=e=>(e=Object.assign({cacheStore:"memory",maxCacheSize:100,ttl:0},e),t.caching({store:e.cacheStore,ttl:e.ttl,length:(e,t)=>Buffer.from(t+t+e).length+2,max:1e6*e.maxCacheSize}));const{headerName:d,headerValue:a}={noop:()=>{},headerName:"X-SSR-Powered-By",headerValue:"@sifrr/seo"};var c=e=>(function(t,n,s){if("GET"!==t.method)return s();const r=e(t),o=t.headers;return null===this.getShouldRenderCache(r,o)&&(n._end=n.end,n.end=(e,t)=>{if(n.hasHeader("content-type")){n.getHeader("content-type").indexOf("html")>=0?this.setShouldRenderCache(r,o,!0):this.setShouldRenderCache(r,o,!1)}n._end(e,t)}),this.render(r,o).then(e=>{e?(n.set(d,a),n.send(e)):s()}).catch(e=>{"No Render"===e.message?s():s(e)})});const u=new RegExp("(headless|Headless)");class l{constructor(e=["Googlebot","Bingbot","Slurp","DuckDuckBot","Baiduspider","YandexBot","Sogou","Exabot"],t={}){this._uas=e.map(e=>new RegExp(e)),this.shouldRenderCache={},this.options=Object.assign({cacheKey:e=>e},t)}get renderer(){return this._renderer=this._renderer||new l.Renderer(this._poptions,this.options),this._renderer}get cache(){return this._cache=this._cache||h(this.options),this._cache}getExpressMiddleware(e=(e=>"http://127.0.0.1:80".concat(e.originalUrl))){return c(e).bind(this)}addUserAgent(e){this._uas.push(new RegExp(e))}setPuppeteerOption(e,t){this._poptions=this._poptions||{},this._poptions[e]=t}close(){return this.renderer.close()}shouldRender(e,t){return this._isUserAgent(t)}setShouldRenderCache(e,t,n){const s=this.options.cacheKey(e,t);this.shouldRenderCache[s]=n}getShouldRenderCache(e,t){const n=this.options.cacheKey(e,t);return void 0===this.shouldRenderCache[n]?null:this.shouldRenderCache[n]}clearCache(){this.cache.reset()}render(e,t){var n=this;return s(function*(){if(!1===n.getShouldRenderCache(e,t))throw Error("No Render");if(n.shouldRender(e,t)&&!n._isHeadless(t)){const s=n.options.cacheKey(e,t);return new Promise((r,o)=>{n.cache.get(s,(i,h)=>{i?o(i):h?r(h):n.renderer.render(e,t).then(e=>{n.cache.set(s,e),r(e)}).catch(e=>{o(e)})})})}throw Error("No Render")})()}_isHeadless(e={}){return!!u.test(e["user-agent"])}_isUserAgent(e={}){const t=e["user-agent"];let n=!1;return this._uas.forEach(e=>{e.test(t)&&(n=!0)}),n}}l.Renderer=i;export default l;
/*! (c) @aadityataparia */
