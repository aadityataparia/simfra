/*! Sifrr.Server v0.0.5 - sifrr project | MIT licensed | https://github.com/sifrr/sifrr */
import t from"uWebSockets.js";import e from"fs";import i from"path";import a from"stream";import o from"chokidar";import r from"zlib";import n from"busboy";import s from"mkdirp";function p(t,e,i,a,o,r,n){try{var s=t[r](n),p=s.value}catch(t){return void i(t)}s.done?e(p):Promise.resolve(p).then(a,o)}function c(t){return function(){var e=this,i=arguments;return new Promise(function(a,o){var r=t.apply(e,i);function n(t){p(r,a,o,n,s,"next",t)}function s(t){p(r,a,o,n,s,"throw",t)}n(void 0)})}}var l={writeHeaders:function(t,e,i){if(void 0!==i)t.writeHeader(e,i.toString());else for(let i in e)t.writeHeader(i,e[i].toString())},extend:function(t,e,i=!0){Object.getOwnPropertyNames(e.prototype).forEach(a=>{"constructor"!==a&&(t[a]&&i&&(t["_".concat(a)]=t[a]),"function"==typeof e.prototype[a]?t[a]=e.prototype[a].bind(t):t[a]=function(t){return"object"==typeof t?Array.isArray(t)?t.slice(0):null===t?null:Object.assign({},t):t}(e.prototype[a]))})},stob:function(t){return new Promise(e=>{const i=[];t.on("data",i.push.bind(i)),t.on("end",()=>{switch(i.length){case 0:e(Buffer.allocUnsafe(0));break;case 1:e(i[0]);break;default:e(Buffer.concat(i))}})})}};const m={"3gp":"video/3gpp",a:"application/octet-stream",ai:"application/postscript",aif:"audio/x-aiff",aiff:"audio/x-aiff",asc:"application/pgp-signature",asf:"video/x-ms-asf",asm:"text/x-asm",asx:"video/x-ms-asf",atom:"application/atom+xml",au:"audio/basic",avi:"video/x-msvideo",bat:"application/x-msdownload",bin:"application/octet-stream",bmp:"image/bmp",bz2:"application/x-bzip2",c:"text/x-c",cab:"application/vnd.ms-cab-compressed",cc:"text/x-c",chm:"application/vnd.ms-htmlhelp",class:"application/octet-stream",com:"application/x-msdownload",conf:"text/plain",cpp:"text/x-c",crt:"application/x-x509-ca-cert",css:"text/css",csv:"text/csv",cxx:"text/x-c",deb:"application/x-debian-package",der:"application/x-x509-ca-cert",diff:"text/x-diff",djv:"image/vnd.djvu",djvu:"image/vnd.djvu",dll:"application/x-msdownload",dmg:"application/octet-stream",doc:"application/msword",dot:"application/msword",dtd:"application/xml-dtd",dvi:"application/x-dvi",ear:"application/java-archive",eml:"message/rfc822",eps:"application/postscript",exe:"application/x-msdownload",f:"text/x-fortran",f77:"text/x-fortran",f90:"text/x-fortran",flv:"video/x-flv",for:"text/x-fortran",gem:"application/octet-stream",gemspec:"text/x-script.ruby",gif:"image/gif",gz:"application/x-gzip",h:"text/x-c",hh:"text/x-c",htm:"text/html",html:"text/html",ico:"image/vnd.microsoft.icon",ics:"text/calendar",ifb:"text/calendar",iso:"application/octet-stream",jar:"application/java-archive",java:"text/x-java-source",jnlp:"application/x-java-jnlp-file",jpeg:"image/jpeg",jpg:"image/jpeg",js:"application/javascript",json:"application/json",log:"text/plain",m3u:"audio/x-mpegurl",m4v:"video/mp4",man:"text/troff",mathml:"application/mathml+xml",mbox:"application/mbox",mdoc:"text/troff",me:"text/troff",mid:"audio/midi",midi:"audio/midi",mime:"message/rfc822",mjs:"application/javascript",mml:"application/mathml+xml",mng:"video/x-mng",mov:"video/quicktime",mp3:"audio/mpeg",mp4:"video/mp4",mp4v:"video/mp4",mpeg:"video/mpeg",mpg:"video/mpeg",ms:"text/troff",msi:"application/x-msdownload",odp:"application/vnd.oasis.opendocument.presentation",ods:"application/vnd.oasis.opendocument.spreadsheet",odt:"application/vnd.oasis.opendocument.text",ogg:"application/ogg",p:"text/x-pascal",pas:"text/x-pascal",pbm:"image/x-portable-bitmap",pdf:"application/pdf",pem:"application/x-x509-ca-cert",pgm:"image/x-portable-graymap",pgp:"application/pgp-encrypted",pkg:"application/octet-stream",pl:"text/x-script.perl",pm:"text/x-script.perl-module",png:"image/png",pnm:"image/x-portable-anymap",ppm:"image/x-portable-pixmap",pps:"application/vnd.ms-powerpoint",ppt:"application/vnd.ms-powerpoint",ps:"application/postscript",psd:"image/vnd.adobe.photoshop",py:"text/x-script.python",qt:"video/quicktime",ra:"audio/x-pn-realaudio",rake:"text/x-script.ruby",ram:"audio/x-pn-realaudio",rar:"application/x-rar-compressed",rb:"text/x-script.ruby",rdf:"application/rdf+xml",roff:"text/troff",rpm:"application/x-redhat-package-manager",rss:"application/rss+xml",rtf:"application/rtf",ru:"text/x-script.ruby",s:"text/x-asm",sgm:"text/sgml",sgml:"text/sgml",sh:"application/x-sh",sig:"application/pgp-signature",snd:"audio/basic",so:"application/octet-stream",svg:"image/svg+xml",svgz:"image/svg+xml",swf:"application/x-shockwave-flash",t:"text/troff",tar:"application/x-tar",tbz:"application/x-bzip-compressed-tar",tcl:"application/x-tcl",tex:"application/x-tex",texi:"application/x-texinfo",texinfo:"application/x-texinfo",text:"text/plain",tif:"image/tiff",tiff:"image/tiff",torrent:"application/x-bittorrent",tr:"text/troff",txt:"text/plain",vcf:"text/x-vcard",vcs:"text/x-vcalendar",vrml:"model/vrml",war:"application/java-archive",wav:"audio/x-wav",wma:"audio/x-ms-wma",wmv:"video/x-ms-wmv",wmx:"video/x-ms-wmx",wrl:"model/vrml",wsdl:"application/wsdl+xml",xbm:"image/x-xbitmap",xhtml:"application/xhtml+xml",xls:"application/vnd.ms-excel",xml:"application/xml",xpm:"image/x-xpixmap",xsl:"application/xml",xslt:"application/xslt+xml",yaml:"text/yaml",yml:"text/yaml",zip:"application/zip",default:"text/html"};var d={getMime:t=>{const e=t.lastIndexOf(".");return m[t.substr(e+1).toLowerCase()]||m.default},mimes:m};const f={br:r.createBrotliCompress,gzip:r.createGzip,deflate:r.createDeflate},{writeHeaders:x}=l,u=d.getMime,h="bytes=",{stob:g}=l;var v=function(t,i,a,o){!function(t,i,a,{lastModified:o=!0,headers:r,compress:n=!1,compressionOptions:s={priority:["gzip","br","deflate"]},cache:p=!1}={}){let{mtime:c,size:l}=e.statSync(a);c.setMilliseconds(0);const m=c.toUTCString();if(r=Object.assign({},r),o){if(i["if-modified-since"]&&new Date(i["if-modified-since"])>=c)return t.writeStatus("304 Not Modified"),t.end();r["last-modified"]=m}r["content-type"]=u(a);let d=0,v=l-1;if(i.range){n=!1;const e=i.range.replace(h,"").split("-");d=parseInt(e[0],10),v=e[1]?parseInt(e[1],10):v,r["accept-ranges"]="bytes",r["content-range"]="bytes ".concat(d,"-").concat(v,"/").concat(l),l=v-d+1,t.writeStatus("206 Partial Content")}v<0&&(v=0);let y=e.createReadStream(a,{start:d,end:v}),b=!1;if(n){const t=s.priority.length;for(let e=0;e<t;e++){const t=s.priority[e];if(i["accept-encoding"].indexOf(t)>-1){b=t;const i=f[t](s);y.pipe(i),y=i,r["content-encoding"]=s.priority[e];break}}}if(t.onAborted(()=>y.destroy()),x(t,r),p)return p.wrap("".concat(a,"_").concat(m,"_").concat(d,"_").concat(v,"_").concat(b),t=>{g(y).then(e=>t(null,e)).catch(t)},{ttl:0},(e,i)=>{if(e)throw t.writeStatus("500 Internal server error"),t.end(),e;t.end(i)});b?y.on("data",e=>{t.write(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength))}):y.on("data",e=>{const i=e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength),a=t.getWriteOffset(),[o,r]=t.tryEnd(i,l);r?y.destroy():o||(y.pause(),t.ab=i,t.abOffset=a,t.onWritable(e=>{const[i,a]=t.tryEnd(t.ab.slice(e-t.abOffset),l);return a?y.destroy():i&&y.resume(),i}))}),y.on("error",()=>{t.writeStatus("500 Internal server error"),t.end(),y.destroy()}).on("end",()=>{t.end()})}(t,{"if-modified-since":i.getHeader("if-modified-since"),range:i.getHeader("range"),"accept-encoding":i.getHeader("accept-encoding")},a,o)};function y(t,e,i){"[]"===e.slice(-2)?(e=e.slice(0,e.length-2),Array.isArray(t[e])?t[e].push(i):t[e]=[i]):Array.isArray(t[e])?t[e].push(i):t[e]?t[e]=[t[e],i]:t[e]=i}var b=function(t,a={}){return a.headers={"content-type":t},new Promise((t,o)=>{const r=new n(a),p={};this.bodyStream().pipe(r),r.on("limit",()=>{a.abortOnLimit&&o(Error("limit"))}),r.on("file",function(t,o,r,n,c){const l={filename:r,encoding:n,mimetype:c};if("string"==typeof a.tmpDir){"function"==typeof a.filename&&(r=a.filename(r));const t=i.join(a.tmpDir,r);s(i.dirname(t)),o.pipe(e.createWriteStream(t)),l.filePath=t}else a.onFile(t,o,r,n,c);y(p,t,l)}),r.on("field",function(t,e){"function"==typeof a.onField&&a.onField(t,e),y(p,t,e)}),r.on("finish",function(){t(p)}),r.on("error",o)})};var w=function t(a,{filter:o=(()=>!0),basePath:r=""}={}){let n;const s=[];return(n=e.statSync(a).isDirectory()?e.readdirSync(a).filter(o).map(t=>i.join(a,t)):[a]).forEach(a=>{if(e.statSync(a).isDirectory())s.push(...t.call(this,a,{filter:o,basePath:r}));else if(".js"===i.extname(a)){const t=function(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}();let e=t.basePath||[""];delete t.basePath,"string"==typeof e&&(e=[e]),e.forEach(e=>{for(const i in t){const a=t[i];for(let t in a)Array.isArray(a[t])||(a[t]=[a[t]]),this[i](r+e+t,...a[t]),s.push(r+e+t)}})}}),s};const{Readable:j}=a,S=["application/x-www-form-urlencoded","multipart/form-data"],_=()=>!0,{stob:A}=l;class O{file(t,e,i={}){if(this._staticPaths[t]){if(i.failOnDuplicateRoute)throw Error("Error serving '".concat(e,"' for '").concat(t,"', already serving '").concat(this._staticPaths[t][0],"' file for this patter."));if(!i.overwriteRoute)return}return this._staticPaths[t]=[e,i],this.get(t,this._serveStatic),this}folder(t,a,r,n=a){if(!e.statSync(a).isDirectory())throw Error("Given path is not a directory: "+a);"/"!==t[0]&&(t="/"+t),"/"===t[t.length-1]&&(t=t.slice(0,-1));const s=r&&r.filter||_;if(e.readdirSync(a).forEach(o=>{const p=i.join(a,o);s(p)&&(e.statSync(p).isDirectory()?this.folder(t,p,r,n):this.file(t+"/"+i.relative(n,p),p,r))}),r&&r.watch&&!this._watched[a]){const e=o.watch(a);e.on("unlink",e=>{const a="/"+i.relative(n,e);delete this._staticPaths[t+a]}),e.on("add",e=>{const a="/"+i.relative(n,e);this.file(t+a,e,r)}),this._watched[a]=e}return this}_serveStatic(t,e){t.onAborted(_);const i=this._staticPaths[e.getUrl()];void 0===i?(t.writeStatus("404 Not Found"),t.end()):v(t,e,i[0],i[1])}post(t,e){if("function"!=typeof e)throw Error("handler should be a function, given ".concat(typeof e,"."));return this._post(t,(t,i)=>{const a=i.getHeader("content-type");t.bodyStream=function(){const t=new j;return t._read=_,this.onData((e,i)=>{t.push(new Uint8Array(e.slice(e.byteOffset,e.byteLength))),i&&t.push(null)}),t},t.body=()=>A(t.bodyStream()),a.indexOf("application/json")>-1&&(t.json=
/* */
c(function*(){return JSON.parse(yield t.body())})),S.map(t=>a.indexOf(t)>-1).indexOf(!0)>-1&&(t.formData=b.bind(t,a)),e(t,i)}),this}load(t,e){return w.call(this,t,e),this}listen(t,e=_,i){return"function"==typeof i?this._listen(t,e,t=>{this._sockets.push(t),i(t)}):this._listen(t,t=>{this._sockets.push(t),e(t)}),this}close(){for(let t in this._watched)this._watched[t].close();return this._sockets.forEach(e=>{t.us_listen_socket_close(e)}),this._sockets=[],this}}O.prototype._staticPaths={},O.prototype._watched={},O.prototype._sockets=[];var k=O;const{extend:P}=l;var E=class extends t.App{constructor(t={}){super(t),P(this,k)}};const{extend:z}=l;const D=()=>{};var H=function({apps:t=[],onListen:e=D}={}){const i=[];for(let a=0;a<t.length;a++){const o=t[a];let{app:r,port:n,ports:s}=o;if(!Array.isArray(s)||0===s.length){if("number"!=typeof n)throw Error("Port should be a number, given ".concat(n));s=[n]}s.forEach(t=>{r.listen(t,t=>{e.call(r,t,n)})}),i.push({app:r,ports:s})}return i},L={App:E,SSLApp:class extends t.SSLApp{constructor(t){super(t),z(this,k)}},mimes:d.mimes,getMime:d.getMime,writeHeaders:l.writeHeaders,sendFile:v,createCluster:H},M=L.App,C=L.SSLApp,F=L.mimes,I=L.getMime,q=L.writeHeaders,N=L.sendFile,R=L.createCluster;export default L;export{M as App,C as SSLApp,R as createCluster,I as getMime,F as mimes,N as sendFile,q as writeHeaders};
/*! (c) @aadityataparia */
