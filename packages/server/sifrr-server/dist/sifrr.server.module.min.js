/*! Sifrr.Server v0.0.5 - sifrr project | MIT licensed | https://github.com/sifrr/sifrr */
import t from"uWebSockets.js";import e from"fs";import i from"path";import a from"stream";import o from"zlib";import n from"busboy";import r from"mkdirp";var s={writeHeaders:function(t,e,i){if(void 0!==i)t.writeHeader(e,i.toString());else for(let i in e)t.writeHeader(i,e[i].toString())},extend:function(t,e,i=!0){Object.getOwnPropertyNames(e.prototype).forEach(a=>{"constructor"!==a&&(t[a]&&i&&(t[`_${a}`]=t[a]),"function"==typeof e.prototype[a]?t[a]=e.prototype[a].bind(t):t[a]=function(t){return"object"==typeof t?Array.isArray(t)?t.slice(0):null===t?null:Object.assign({},t):t}(e.prototype[a]))})}};const p={"3gp":"video/3gpp",a:"application/octet-stream",ai:"application/postscript",aif:"audio/x-aiff",aiff:"audio/x-aiff",asc:"application/pgp-signature",asf:"video/x-ms-asf",asm:"text/x-asm",asx:"video/x-ms-asf",atom:"application/atom+xml",au:"audio/basic",avi:"video/x-msvideo",bat:"application/x-msdownload",bin:"application/octet-stream",bmp:"image/bmp",bz2:"application/x-bzip2",c:"text/x-c",cab:"application/vnd.ms-cab-compressed",cc:"text/x-c",chm:"application/vnd.ms-htmlhelp",class:"application/octet-stream",com:"application/x-msdownload",conf:"text/plain",cpp:"text/x-c",crt:"application/x-x509-ca-cert",css:"text/css",csv:"text/csv",cxx:"text/x-c",deb:"application/x-debian-package",der:"application/x-x509-ca-cert",diff:"text/x-diff",djv:"image/vnd.djvu",djvu:"image/vnd.djvu",dll:"application/x-msdownload",dmg:"application/octet-stream",doc:"application/msword",dot:"application/msword",dtd:"application/xml-dtd",dvi:"application/x-dvi",ear:"application/java-archive",eml:"message/rfc822",eps:"application/postscript",exe:"application/x-msdownload",f:"text/x-fortran",f77:"text/x-fortran",f90:"text/x-fortran",flv:"video/x-flv",for:"text/x-fortran",gem:"application/octet-stream",gemspec:"text/x-script.ruby",gif:"image/gif",gz:"application/x-gzip",h:"text/x-c",hh:"text/x-c",htm:"text/html",html:"text/html",ico:"image/vnd.microsoft.icon",ics:"text/calendar",ifb:"text/calendar",iso:"application/octet-stream",jar:"application/java-archive",java:"text/x-java-source",jnlp:"application/x-java-jnlp-file",jpeg:"image/jpeg",jpg:"image/jpeg",js:"application/javascript",json:"application/json",log:"text/plain",m3u:"audio/x-mpegurl",m4v:"video/mp4",man:"text/troff",mathml:"application/mathml+xml",mbox:"application/mbox",mdoc:"text/troff",me:"text/troff",mid:"audio/midi",midi:"audio/midi",mime:"message/rfc822",mjs:"application/javascript",mml:"application/mathml+xml",mng:"video/x-mng",mov:"video/quicktime",mp3:"audio/mpeg",mp4:"video/mp4",mp4v:"video/mp4",mpeg:"video/mpeg",mpg:"video/mpeg",ms:"text/troff",msi:"application/x-msdownload",odp:"application/vnd.oasis.opendocument.presentation",ods:"application/vnd.oasis.opendocument.spreadsheet",odt:"application/vnd.oasis.opendocument.text",ogg:"application/ogg",p:"text/x-pascal",pas:"text/x-pascal",pbm:"image/x-portable-bitmap",pdf:"application/pdf",pem:"application/x-x509-ca-cert",pgm:"image/x-portable-graymap",pgp:"application/pgp-encrypted",pkg:"application/octet-stream",pl:"text/x-script.perl",pm:"text/x-script.perl-module",png:"image/png",pnm:"image/x-portable-anymap",ppm:"image/x-portable-pixmap",pps:"application/vnd.ms-powerpoint",ppt:"application/vnd.ms-powerpoint",ps:"application/postscript",psd:"image/vnd.adobe.photoshop",py:"text/x-script.python",qt:"video/quicktime",ra:"audio/x-pn-realaudio",rake:"text/x-script.ruby",ram:"audio/x-pn-realaudio",rar:"application/x-rar-compressed",rb:"text/x-script.ruby",rdf:"application/rdf+xml",roff:"text/troff",rpm:"application/x-redhat-package-manager",rss:"application/rss+xml",rtf:"application/rtf",ru:"text/x-script.ruby",s:"text/x-asm",sgm:"text/sgml",sgml:"text/sgml",sh:"application/x-sh",sig:"application/pgp-signature",snd:"audio/basic",so:"application/octet-stream",svg:"image/svg+xml",svgz:"image/svg+xml",swf:"application/x-shockwave-flash",t:"text/troff",tar:"application/x-tar",tbz:"application/x-bzip-compressed-tar",tcl:"application/x-tcl",tex:"application/x-tex",texi:"application/x-texinfo",texinfo:"application/x-texinfo",text:"text/plain",tif:"image/tiff",tiff:"image/tiff",torrent:"application/x-bittorrent",tr:"text/troff",txt:"text/plain",vcf:"text/x-vcard",vcs:"text/x-vcalendar",vrml:"model/vrml",war:"application/java-archive",wav:"audio/x-wav",wma:"audio/x-ms-wma",wmv:"video/x-ms-wmv",wmx:"video/x-ms-wmx",wrl:"model/vrml",wsdl:"application/wsdl+xml",xbm:"image/x-xbitmap",xhtml:"application/xhtml+xml",xls:"application/vnd.ms-excel",xml:"application/xml",xpm:"image/x-xpixmap",xsl:"application/xml",xslt:"application/xslt+xml",yaml:"text/yaml",yml:"text/yaml",zip:"application/zip",default:"text/html"};var c={getMime:t=>{const e=t.lastIndexOf(".");return p[t.substr(e+1).toLowerCase()]||p.default},mimes:p};var l=function(t){return new Promise(e=>{const i=[];t.on("data",i.push.bind(i)),t.on("end",()=>{switch(i.length){case 0:e(Buffer.allocUnsafe(0));break;case 1:e(i[0]);break;default:e(Buffer.concat(i))}})})};const m={br:o.createBrotliCompress,gzip:o.createGzip,deflate:o.createDeflate},{writeHeaders:d}=s,f=c.getMime,x="bytes=";var u=function(t,i,a,o){!function(t,i,a,{lastModified:o=!0,headers:n,compress:r=!1,compressionOptions:s={priority:["gzip","br","deflate"]},cache:p=!1}={}){let{mtime:c,size:u}=e.statSync(a);c.setMilliseconds(0);const g=c.toUTCString();if(n=Object.assign({},n),o){if(i["if-modified-since"]&&new Date(i["if-modified-since"])>=c)return t.writeStatus("304 Not Modified"),t.end();n["last-modified"]=g}n["content-type"]=f(a);let h=0,v=u-1;if(i.range){r=!1;const e=i.range.replace(x,"").split("-");h=parseInt(e[0],10),v=e[1]?parseInt(e[1],10):v,n["accept-ranges"]="bytes",n["content-range"]=`bytes ${h}-${v}/${u}`,u=v-h+1,t.writeStatus("206 Partial Content")}v<0&&(v=0);let y=e.createReadStream(a,{start:h,end:v}),b=!1;if(r){const t=s.priority.length;for(let e=0;e<t;e++){const t=s.priority[e];if(i["accept-encoding"].indexOf(t)>-1){b=!0;const i=m[t](s);y.pipe(i),y=i,n["content-encoding"]=s.priority[e];break}}}if(t.onAborted(()=>y.destroy()),d(t,n),p&&!b)return p.wrap(`${a}_${g}_${h}_${v}`,t=>{l(y).then(e=>t(null,e.toString("utf-8"))).catch(t)},{ttl:0},(e,i)=>{if(e)throw t.writeStatus("500 Internal server error"),t.end(),e;t.end(i)});b?y.on("data",e=>{t.write(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength))}):y.on("data",e=>{const i=e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength),a=t.getWriteOffset(),[o,n]=t.tryEnd(i,u);n?y.destroy():o||(y.pause(),t.ab=i,t.abOffset=a,t.onWritable(e=>{const[i,a]=t.tryEnd(t.ab.slice(e-t.abOffset),u);return a?y.destroy():i&&y.resume(),i}))}),y.on("error",()=>{t.writeStatus("500 Internal server error"),t.end(),y.destroy()}).on("end",()=>{t.end()})}(t,{"if-modified-since":i.getHeader("if-modified-since"),range:i.getHeader("range"),"accept-encoding":i.getHeader("accept-encoding")},a,o)};function g(t,e,i){"[]"===e.slice(-2)?(e=e.slice(0,e.length-2),Array.isArray(t[e])?t[e].push(i):t[e]=[i]):Array.isArray(t[e])?t[e].push(i):t[e]?t[e]=[t[e],i]:t[e]=i}var h=function(t,i={}){return i.headers={"content-type":t},new Promise((t,a)=>{const o=new n(i),s={};this.bodyStream().pipe(o),o.on("limit",()=>{i.abortOnLimit&&a("limit")}),o.on("file",function(t,a,o,n,p){const c={filename:o,encoding:n,mimetype:p};if("string"==typeof i.tmpDir){"function"==typeof i.filename&&(o=i.filename(o));const t=path.join(i.tmpDir,o);r(path.dirname(t)),a.pipe(e.createWriteStream(t)),c.filePath=t}else i.onFile(t,a,o,n,p);g(s,t,c)}),o.on("field",function(t,e){"function"==typeof i.onField&&i.onField(t,e),g(s,t,e)}),o.on("finish",function(){t(s)}),o.on("error",a)})};var v=function t(a,{filter:o=(()=>!0),basePath:n=""}={}){let r;const s=[];return(r=e.statSync(a).isDirectory()?e.readdirSync(a).filter(o).map(t=>i.join(a,t)):[a]).forEach(a=>{if(e.statSync(a).isDirectory())s.push(...t.call(this,a,{filter:o,basePath:n}));else if(".js"===i.extname(a)){const t=function(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}();let e=t.basePath||[""];delete t.basePath,"string"==typeof e&&(e=[e]),e.forEach(e=>{for(const i in t){const a=t[i];for(let t in a)Array.isArray(a[t])||(a[t]=[a[t]]),this[i](n+e+t,...a[t]),s.push(n+e+t)}})}}),s};const{Readable:y}=a,b=["application/x-www-form-urlencoded","multipart/form-data"],w=()=>!0;class j{file(t,e,i){return this.get(t,(t,a)=>{u(t,a,e,i)}),this}folder(t,a,o,n=a){if(!e.statSync(a).isDirectory())throw Error("Given path is not a directory: "+a);"/"!==t[0]&&(t="/"+t),"/"===t[t.length-1]&&(t=t.slice(0,-1));const r=o&&o.filter||w;return e.readdirSync(a).forEach(s=>{const p=i.join(a,s);if(r(p))if(e.statSync(p).isDirectory())this.folder(t,p,o,n);else{const e="/"+i.relative(n,p);if(this._staticPaths[t+e])return;this._staticPaths[t+e]=[p,o],this.get(t+e,this._serveStatic)}}),o&&o.watch&&this._watched.indexOf(a)<0&&(e.watch(a,(s,p)=>{if("rename"===s){if(!p)return;const s=i.join(a,p),c="/"+i.relative(n,s);e.existsSync(s)&&r(s)?(this._staticPaths[t+c]=[s,o],this.get(t+c,this._serveStatic)):delete this._staticPaths[t+c]}}),this._watched.push(a)),this}_serveStatic(t,e){const i=this._staticPaths[e.getUrl()];void 0===i?(t.writeStatus("404 Not Found"),t.end()):u(t,e,i[0],i[1])}post(t,e){if("function"!=typeof e)throw Error(`handler should be a function, given ${typeof e}.`);return this._post(t,(t,i)=>{const a=i.getHeader("content-type");t.bodyStream=function(){const t=new y;return t._read=w,this.onData((e,i)=>{t.push(new Uint8Array(e.slice(e.byteOffset,e.byteLength))),i&&t.push(null)}),t},t.body=()=>l(t.bodyStream()),a.indexOf("application/json")>-1&&(t.json=async()=>JSON.parse(await t.body())),b.map(t=>a.indexOf(t)>-1).indexOf(!0)>-1&&(t.formData=h.bind(t,a)),e(t,i)}),this}load(t,e){return v.call(this,t,e),this}listen(t,e=w,i){return"function"==typeof i?this._listen(t,e,t=>{this._socket=t,i(t)}):this._listen(t,t=>{this._socket=t,e(t)}),this}close(){return this._socket&&(t.us_listen_socket_close(this._socket),this._socket=null),this}}j.prototype._staticPaths={},j.prototype._watched=[];var S=j;const{extend:_}=s;var O=class extends t.App{constructor(t={}){super(t),_(this,S)}};const{extend:k}=s;var A={App:O,SSLApp:class extends t.SSLApp{constructor(t){super(t),k(this,S)}},mimes:c.mimes,getMime:c.getMime,writeHeaders:s.writeHeaders,sendFile:u},P=A.App,z=A.SSLApp,H=A.mimes,D=A.getMime,E=A.writeHeaders,L=A.sendFile;export default A;export{P as App,z as SSLApp,D as getMime,H as mimes,L as sendFile,E as writeHeaders};
/*! (c) @aadityataparia */
