<template>
  <style>
    :host {
      display: none;
    }
    :host(.active) {
      display: block;
    }
  </style>
  <slot></slot>
</template>
<script>
  SF.observedAttributes['sf-route'] = ['data-route'];
  SF.attributeChangedCallback["sf-route"] = function(el, attrName, oldVal, newVal) {
    if (attrName == 'data-route') {
      refreshRoute();
    }
  }

  SF.clickEvents['a'] = function(el, e) {
    if (el.host == window.location.host) {
      e.preventDefault();
      var stateObj = {
        location: el.pathname
      };
      history.pushState(stateObj, "Home", el.pathname);
      refreshRoute();
    }
  }

  function refreshRoute() {
    let path = SF.getRoutes(window.location.pathname);
    document.querySelectorAll('sf-route').forEach(function(el) {
      let route = SF.getRoutes(el.dataset.route);
      let data = {};
      makeRouteInactive(el);
      for (const [i, r] of route.entries()) {
        if (r == '..') {
          makeRouteActive(el, data);
          return;
        } else if (typeof path[i] == 'undefined') {
          makeRouteInactive(el);
          return;
        } else if (r == path[i] || r == '*') {
          continue;
        } else if (r[0] == ':') {
          data[r.substr(1)] = path[i];
          continue;
        } else {
          makeRouteInactive(el);
          return
        }
      }
      makeRouteActive(el, data);
    });
  }

  function makeRouteActive(el, data) {
    let newHtml = SF.replaceHTML(el.dataset.originalSlotHtml, data, '#{route');
    if (el.innerHTML !== newHtml) {
      el.innerHTML = newHtml;
    }
    addClass(el, 'active');
  }
</script>