#!/usr/bin/env bash

set -x

STATUS=0

if [[ $COVERAGE == 'true' ]]; then
  rm -rf ./.nyc_output
fi

if [ -z ${CIRCLE_NODE_TOTAL} ]; then
  FILES="sifrr"
else
  FILES=`circleci tests glob "packages/**/*.test.js" | circleci tests split --split-by=timings`
fi

for dir in packages/*/*
do
  echo "Running test in ${dir}:"

  node ./scripts/test/run.js "${dir}" "$@" -f "${FILES}"

  NEW_STATUS=$?
  [ $NEW_STATUS -eq 0 ] || STATUS=$NEW_STATUS
done

if [[ $COVERAGE == 'true' ]]; then
  if [[ $LCOV == 'true' ]]; then
    COVERALLS_PARALLEL=true cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js
  fi
fi

exit $STATUS # Exit with 1 if any test failed
